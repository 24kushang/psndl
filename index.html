<!DOCTYPE html>
<html>
<head>
<meta charset="utf8">
<meta content="width=device-width, user-scalable=no" name="viewport"/>
<script>
	$=document.querySelector.bind(document);
	var DB;
	function makeRap(row){
		if(row[3]=="")return ""
		if(row[3]==0 )return '<span title="Press Circle in ReactPSN to activate this game">(o)</span>'//\u233E\u25CB\u26AA\u29BF\u29BE
		return '<a download="'+row[1]+'-'+row[0]+'_00-'+row[3].substr(16)+'.rap" href="data:application/stream;base64,'+btoa((row[3].match(/../g)||[]).map(function(x){return String.fromCharCode(parseInt(x,16))}).join(''))+'">RAP</a>'
	}
	function searchDB(q,out){
		$("#about").hidden = !(out.hidden = !q);
		var rule=new RegExp(q,'i');
		out.innerHTML=DB.filter(function(a){return a[4].match(rule)}).slice(0,100).map(function(a){return '<li><a href="http://zeus.dl.playstation.net/cdn/'+a[1]+'/'+a[0]+'_00/'+a[2]+'.pkg">'+a[4]+" ("+a[0][2]+")</a> "+makeRap(a)+"</li>"}).join('')
	}
	function loadDB(url){
		$('#q').disabled=!localStorage['DB'];
		if(!localStorage['DB']){//DB not in cache
			$('#q').placeholder="Loading DataBase ..."
			var xhr = new XMLHttpRequest();
			xhr.onload=function(ev){//xhr.onloadend
				localStorage['DB']=JSON.stringify(ev.target.response.split("\n").map(function(c){return c.split(';')}))
				loadDB();//now that the DB is in localstorage, do a self-call
			}
			xhr.open('GET',url);
			xhr.send();
		}else{
			DB=JSON.parse(localStorage['DB'])
			$('#q').placeholder="Search in "+DB.length+" url"
			document.body.onhashchange()//trigger a hash search (if any)
		}
	}
</script>
<style>
	ul{padding:0;list-style:none;}
	*[title]{cursor:help;}
</style>
</head>
<body onload="loadDB('db.csv')" onhashchange="try{searchDB(document.location.hash.substr(1),$('#list'))}catch(e){alert(e)}">
	<form onsubmit="document.location.hash=this.elements['q'].value;return false;">
		<input type="text" id="q" onkeyup="this.form.onsubmit()"/>
		<input type="submit" value="search"/>
	</form>
	<p id="about">
#Welcome to the PSN repository.

- [Fork](https://github.com/yne/PSN) this project.
- [Pull requests](https://github.com/yne/PSN/pulls) are welcome.
- [Report](https://github.com/yne/PSN/issues/new) a bug/issue/idea/request.
- [Download](https://github.com/yne/PSN/archive/gh-pages.zip) the sources.
- [View](https://raw.githubusercontent.com/yne/PSN/gh-pages/db.csv) the current database
	</p>
	<ul id="list"/>
	<script src="//cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
	<script>$('#about').innerHTML=marked($('#about').innerHTML)</script>
</body>
</html>
